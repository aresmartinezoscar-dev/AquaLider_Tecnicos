<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#06b6d4">
    <meta name="description" content="Monitoreo de sistemas de acuapon√≠a offline">
    <title>Acuapon√≠a Monitor</title>
    <link rel="manifest" href="/acuaponia-app/public/manifest.webmanifest">
    <link rel="stylesheet" href="https://aresmartinezoscar-dev.github.io/acuaponia-app/public/src/css/styles.css">
    <link rel="icon" type="image/png" href="/acuaponia-app/public/assets/icon-192.png">
</head>

<body>
    <!-- Banner de alertas -->
    <div id="alert-banner" class="alert-banner hidden"></div>

    <!-- Selector de usuarios -->
    <div id="user-selector-container" class="user-selector-container hidden">
        <button id="user-selector-btn" class="user-selector-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
            <span id="current-user-display">Usuario</span>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
            </svg>
        </button>
        
        <div id="user-dropdown" class="user-dropdown hidden">
            <div class="user-dropdown-header">
                Cambiar Usuario
            </div>
            <div id="users-list" class="users-list">
                <!-- Lista de usuarios se llenar√° din√°micamente -->
            </div>
            <button class="user-dropdown-add" onclick="addNewUser()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="16"/>
                    <line x1="8" y1="12" x2="16" y2="12"/>
                </svg>
                A√±adir Nuevo Usuario
            </button>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div id="app">
        <!-- Vista de primer uso -->
        <div id="first-run-view" class="view hidden">
            <div class="welcome-container">
                <div class="welcome-header">
                    <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" />
                    </svg>
                    <h1>Acuapon√≠a</h1>
                    <p class="subtitle">Monitoreo inteligente</p>
                </div>
                <form id="first-run-form" class="welcome-form">
                    <div class="form-group">
                        <label for="user-code">C√≥digo de usuario *</label>
                        <input type="text" id="user-code" required placeholder="Ingresa tu c√≥digo">
                    </div>
                    <div class="form-group">
                        <label for="system-name">Nombre del sistema (opcional)</label>
                        <input type="text" id="system-name" placeholder="Ej: Sistema Principal">
                    </div>
                    <button type="submit" class="btn btn-primary">Comenzar</button>
                </form>
            </div>
        </div>

        <!-- Vista Home -->
        <div id="home-view" class="view hidden">
            <div class="header">
                <svg class="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" />
                </svg>
                <h1>Acuapon√≠a</h1>
                <p id="system-name-display" class="system-name"></p>
            </div>

            <div class="actions-grid">
                <button class="action-card" data-view="add">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="8" x2="12" y2="16" />
                        <line x1="8" y1="12" x2="16" y2="12" />
                    </svg>
                    <span>A√±adir medici√≥n</span>
                </button>
                <button class="action-card" data-view="history">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                    </svg>
                    <span>Ver hist√≥rico</span>
                </button>
            </div>

            <div id="last-values-container" class="card hidden">
                <h2 class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
                    </svg>
                    √öltimos valores
                </h2>
                <div id="last-values-grid" class="values-grid"></div>
            </div>

            <div class="bottom-actions">
                <button id="sync-button" class="btn btn-primary">
                    <svg id="sync-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                    <span id="sync-text">Sincronizar</span>
                </button>
                <button class="btn btn-secondary" data-view="settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m-9-9h6m6 0h6"/>
                    </svg>
                    <span>Ajustes</span>
                </button>
            </div>
        </div>

        <!-- Vista A√±adir Medici√≥n -->
        <div id="add-view" class="view hidden">
            <div class="view-header">
                <button class="btn-back" data-view="home">‚¨ÖÔ∏è</button>
                <h1>A√±adir medici√≥n</h1>
            </div>

            <div class="measurements-container">
                <!-- Comida -->
                <form class="measurement-form card" data-type="comida">
                    <div class="form-header">
                        <span class="emoji-icon">üçΩÔ∏è</span>
                        <h3>Comida administrada</h3>
                    </div>
                    <div class="form-input-group">
                        <input type="number" step="0.1" min="0" max="1000" required placeholder="Cantidad">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>

                <!-- Comentarios -->
                <form id="comment-form" class="measurement-form card">
                    <div class="form-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                        </svg>
                        <h3>A√±adir comentario</h3>
                    </div>
                    <div class="form-input-group">
                        <textarea rows="2" required placeholder="Escribe un comentario..."></textarea>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>

                <!-- pH -->
                <form class="measurement-form card" data-type="ph">
                    <div class="form-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                        </svg>
                        <h3>pH</h3>
                    </div>
                    <div class="form-input-group">
                        <input type="number" step="0.1" min="0" max="14" required placeholder="Valor de pH">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>

                <!-- Amonio -->
                <form class="measurement-form card" data-type="amonio">
                    <div class="form-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <circle cx="12" cy="12" r="4" />
                        </svg>
                        <h3>Amonio (NAT)</h3>
                    </div>
                    <div class="form-input-group">
                        <input type="number" step="0.01" min="0" max="10" required placeholder="ppm">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>

                <!-- Nitrito -->
                <form class="measurement-form card" data-type="nitrito">
                    <div class="form-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v20M2 12h20" />
                        </svg>
                        <h3>Nitrito (NO2)</h3>
                    </div>
                    <div class="form-input-group">
                        <input type="number" step="0.01" min="0" max="10" required placeholder="ppm">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>

                <!-- Nitrato -->
                <form class="measurement-form card" data-type="nitrato">
                    <div class="form-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 2 7 12 12 22 7 12 2" />
                            <polyline points="2 17 12 22 22 17" />
                            <polyline points="2 12 12 17 22 12" />
                        </svg>
                        <h3>Nitrato (NO3)</h3>
                    </div>
                    <div class="form-input-group">
                        <input type="number" step="0.1" min="0" max="200" required placeholder="ppm">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>

                <!-- Mortalidad -->
                <form class="measurement-form card" data-type="mortalidad">
                    <div class="form-header">
                        <span class="emoji-icon">‚ò†Ô∏è</span>
                        <h3>Mortalidad</h3>
                    </div>
                    <div class="form-input-group">
                        <input type="number" step="1" min="0" max="10000" required placeholder="N√∫mero de peces">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>

                <!-- Dureza -->
                <form class="measurement-form card optional-param" data-type="dureza" style="display: none;">
                    <div class="form-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                        <h3>Dureza</h3>
                    </div>
                    <div class="form-input-group">
                        <input type="number" step="0.1" min="0" max="1000" required placeholder="ppm">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>

                <!-- Temperatura -->
                <form class="measurement-form card" data-type="temp">
                    <div class="form-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z" />
                        </svg>
                        <h3>Temperatura</h3>
                    </div>
                    <div class="form-input-group">
                        <input type="number" step="0.1" min="0" max="50" required placeholder="¬∞C">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>

                <!-- Nivel de agua -->
                <form class="measurement-form card" data-type="nivel">
                    <div class="form-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" />
                        </svg>
                        <h3>Nivel de agua</h3>
                    </div>
                    <div class="form-input-group">
                        <input type="number" step="1" min="0" max="100" required placeholder="cm">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>

                <!-- Conductividad El√©ctrica -->
                <form class="measurement-form card" data-type="conductividad">
                    <div class="form-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                        </svg>
                        <h3>C. El√©ctrica</h3>
                    </div>
                    <div class="form-input-group">
                        <input type="number" step="0.01" min="0" max="500" required placeholder="S/m">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>

                <!-- Registrar Dato Hist√≥rico -->
                <div class="historical-data-section">
                    <div class="historical-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <h3>Registrar Dato Hist√≥rico</h3>
                    </div>
                    <p class="historical-description">
                        A√±ade mediciones de fechas anteriores
                    </p>
                    
                    <form id="historical-form" class="historical-form">
                        <div class="historical-inputs">
                            <div class="historical-field">
                                <label for="historical-date">Fecha</label>
                                <input type="date" id="historical-date" required max="">
                            </div>
                            
                            <div class="historical-field">
                                <label for="historical-param">Par√°metro</label>
                                <select id="historical-param" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="ph">pH</option>
                                    <option value="temp">Temperatura</option>
                                    <option value="nivel">Nivel de agua</option>
                                    <option value="conductividad">C. El√©ctrica</option>
                                    <option value="dureza">Dureza</option>
                                    <option value="amonio">Amonio (NAT)</option>
                                    <option value="nitrito">Nitrito (NO2)</option>
                                    <option value="nitrato">Nitrato (NO3)</option>
                                    <option value="mortalidad">Mortalidad</option>
                                    <option value="comida">Comida</option>
                                </select>
                            </div>
                            
                            <div class="historical-field">
                                <label for="historical-value">Valor</label>
                                <input type="number" id="historical-value" step="0.01" required placeholder="Valor">
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            üíæ Guardar Dato Hist√≥rico
                        </button>
                    </form>
                </div>

            </div>
        </div>

        <!-- Vista Hist√≥rico -->
        <div id="history-view" class="view hidden">
            <div class="view-header">
                <button class="btn-back" data-view="home">‚¨ÖÔ∏è</button>
                <h1>Hist√≥rico</h1>
            </div>

            <div class="tabs" id="history-tabs">
                <button class="tab active" data-param="ph">pH</button>
                <button class="tab" data-param="temp">Temp</button>
                <button class="tab" data-param="nivel">Nivel</button>
                <button class="tab" data-param="conductividad">C.El√©c</button>
                <button class="tab" data-param="dureza">Dureza</button>
                <button class="tab" data-param="amonio">NAT</button>
                <button class="tab" data-param="nitrito">NO2</button>
                <button class="tab" data-param="nitrato">NO3</button>
                <button class="tab" data-param="mortalidad">‚ò†Ô∏è</button>
                <button class="tab" data-param="comida">Comida</button>
            </div>

            <div class="card">
                <canvas id="chart-canvas"></canvas>
            </div>

            <div class="card">
                <h2 class="card-title">Registros recientes</h2>
                <div id="measurements-list"></div>
            </div>

            <div class="card">
                <h2 class="card-title">Comentarios</h2>
                <div id="comments-list"></div>
            </div>
        </div>

        <!-- Vista Ajustes -->
        <div id="settings-view" class="view hidden">
            <div class="view-header">
                <button class="btn-back" data-view="home">‚¨ÖÔ∏è</button>
                <h1>Ajustes</h1>
            </div>

            <form id="settings-form">
                <!-- Botones de configuraci√≥n -->
                <div class="card">
                    <h3>Configuraci√≥n de Par√°metros</h3>
                    <button type="button" class="btn btn-secondary" onclick="showParameterSelection()"
                        style="width: 100%; margin-bottom: 12px;">
                        ‚òëÔ∏è Seleccionar Par√°metros
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showThresholdSettings()"
                        style="width: 100%;">
                        ‚öôÔ∏è Ajustar Umbrales
                    </button>
                </div>

                
                <h3>Unidad de comida</h3>
                <select name="unidadComida">
                    <option value="g">Gramos (g)</option>
                    <option value="cucharadas">Cucharadas</option>
                    <option value="ml">Mililitros (ml)</option>
                    <option value="otro">Otro</option>
                </select>
                
                <div class="card">
                    <h3>Apariencia</h3>
                    <label class="switch-label">
                        <input type="checkbox" name="modoOscuro">
                        <span>Modo oscuro</span>
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary">Guardar cambios</button>
                
                <div class="card">
                    <h3>Informaci√≥n del usuario</h3>
                    <p id="user-info" class="user-info"></p>
                </div>
            </form>

        </div>

        
    </div>

    <!-- Modal de selecci√≥n de par√°metros -->
    <div id="parameter-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Seleccionar Par√°metros</h3>
                <button class="modal-close" onclick="closeParameterModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--color-text-secondary); margin-bottom: 16px;">
                    Marca los par√°metros que quieres medir:
                </p>
    
                <label class="checkbox-label">
                    <input type="checkbox" name="param-ph" checked disabled>
                    <span>pH (obligatorio)</span>
                </label>
    
                <label class="checkbox-label">
                    <input type="checkbox" name="param-temp">
                    <span>Temperatura</span>
                </label>
    
                <label class="checkbox-label">
                    <input type="checkbox" name="param-nivel">
                    <span>Nivel de agua</span>
                </label>
    
                <label class="checkbox-label">
                    <input type="checkbox" name="param-conductividad">
                    <span>Conductividad El√©ctrica</span>
                </label>
    
                <label class="checkbox-label">
                    <input type="checkbox" name="param-dureza">
                    <span>Dureza</span>
                </label>
    
                <label class="checkbox-label">
                    <input type="checkbox" name="param-amonio" checked disabled>
                    <span>Amonio (NAT) (obligatorio)</span>
                </label>
    
                <label class="checkbox-label">
                    <input type="checkbox" name="param-nitrito" checked disabled>
                    <span>Nitrito (NO2) (obligatorio)</span>
                </label>
    
                <label class="checkbox-label">
                    <input type="checkbox" name="param-nitrato" checked disabled>
                    <span>Nitrato (NO3) (obligatorio)</span>
                </label>
    
                <label class="checkbox-label">
                    <input type="checkbox" name="param-mortalidad" checked disabled>
                    <span>Mortalidad (obligatorio)</span>
                </label>
    
                <label class="checkbox-label">
                    <input type="checkbox" name="param-comida" checked disabled>
                    <span>Comida administrada (obligatorio)</span>
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveParameterSelection()">Guardar</button>
                <button class="btn btn-secondary" onclick="closeParameterModal()">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de umbrales -->
    <div id="threshold-modal" class="modal hidden">
        <div class="modal-content threshold-modal-content">
            <div class="modal-header">
                <h3>Ajustar Umbrales</h3>
                <button class="modal-close" onclick="closeThresholdModal()">‚úï</button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
    
                <div class="threshold-section">
                    <h4>pH</h4>
                    <div class="settings-row">
                        <label>M√≠nimo</label>
                        <input type="number" step="0.1" name="umbralPhMin" required>
                    </div>
                    <div class="settings-row">
                        <label>M√°ximo</label>
                        <input type="number" step="0.1" name="umbralPhMax" required>
                    </div>
                </div>
    
                <div class="threshold-section">
                    <h4>Conductividad El√©ctrica</h4>
                    <div class="settings-row">
                        <label>M√≠nimo (S/m)</label>
                        <input type="number" step="0.01" name="umbralCondMin" required>
                    </div>
                    <div class="settings-row">
                        <label>M√°ximo (S/m)</label>
                        <input type="number" step="0.01" name="umbralCondMax" required>
                    </div>
                </div>
    
                <div class="threshold-section">
                    <h4>Amonio (NAT)</h4>
                    <div class="settings-row">
                        <label>M√≠nimo (ppm)</label>
                        <input type="number" step="0.01" name="umbralAmonioMin" required>
                    </div>
                    <div class="settings-row">
                        <label>M√°ximo (ppm)</label>
                        <input type="number" step="0.01" name="umbralAmonioMax" required>
                    </div>
                </div>
    
                <div class="threshold-section">
                    <h4>Nitrito (NO2)</h4>
                    <div class="settings-row">
                        <label>M√≠nimo (ppm)</label>
                        <input type="number" step="0.01" name="umbralNitritoMin" required>
                    </div>
                    <div class="settings-row">
                        <label>M√°ximo (ppm)</label>
                        <input type="number" step="0.01" name="umbralNitritoMax" required>
                    </div>
                </div>
    
                <div class="threshold-section">
                    <h4>Nitrato (NO3)</h4>
                    <div class="settings-row">
                        <label>M√≠nimo (ppm)</label>
                        <input type="number" step="0.1" name="umbralNitratoMin" required>
                    </div>
                    <div class="settings-row">
                        <label>M√°ximo (ppm)</label>
                        <input type="number" step="0.1" name="umbralNitratoMax" required>
                    </div>
                </div>
    
                <div class="threshold-section">
                    <h4>Nivel de Agua</h4>
                    <div class="settings-row">
                        <label>M√≠nimo (cm)</label>
                        <input type="number" name="minNivel" required>
                    </div>
                    <div class="settings-row">
                        <label>M√°ximo (cm)</label>
                        <input type="number" name="maxNivel" required>
                    </div>
                </div>
    
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveThresholdSettings()">Guardar</button>
                <button class="btn btn-secondary" onclick="closeThresholdModal()">Cancelar</button>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script type="module" src="/acuaponia-app/public/src/js/main.js"></script>
    <script type="module">
        // Forzar ruta base
        const BASE = 'https://aresmartinezoscar-dev.github.io/acuaponia-app/public/';

        // Importar main.js
        import(BASE + 'src/js/main.js');
    </script>
    <script>
        function toggleLock(cardId) {
            const card = document.getElementById(cardId);
            const btn = card.querySelector('.unlock-btn');
            if (card.classList.contains('locked')) {
                card.classList.remove('locked');
                btn.textContent = 'üîì';
            } else {
                card.classList.add('locked');
                btn.textContent = 'üîí';
            }
        }
    </script>
    <script>
    // Prevenir recarga al rotar
    let lastWidth = window.innerWidth;
    let lastHeight = window.innerHeight;
    
    window.addEventListener('resize', () => {
        const newWidth = window.innerWidth;
        const newHeight = window.innerHeight;
        
        // Solo es rotaci√≥n si cambian ambas dimensiones significativamente
        if (Math.abs(lastWidth - newWidth) > 100 || Math.abs(lastHeight - newHeight) > 100) {
            console.log('üîÑ Rotaci√≥n detectada - manteniendo estado');
            lastWidth = newWidth;
            lastHeight = newHeight;
        }
    });
    
    // Guardar estado antes de cualquier descarga
    window.addEventListener('beforeunload', () => {
        sessionStorage.setItem('lastView', currentView || 'home');
    });
    
    // Restaurar estado al cargar
    window.addEventListener('load', () => {
        const lastView = sessionStorage.getItem('lastView');
        if (lastView && lastView !== 'home') {
            console.log('üîÑ Restaurando vista:', lastView);
            // La vista se restaurar√° autom√°ticamente por el sistema
        }
    });
    </script>
</body>

</html>



